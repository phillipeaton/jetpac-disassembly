<!DOCTYPE html>
<html>
<head>
<title>jetpac: Routine at 7638</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html">jetpac</a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="30204.html">75fc</a>
</td>
<td class="up">Up: <a href="../maps/all.html#30264">Map</a></td>
<td class="next">
Next: <a href="30374.html">76a6</a>
</td>
</tr>
</table>
<div class="description">7638: Displays platforms on screen.</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="24724.html">6094</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="30264"></span>7638</td>
<td class="instruction">ld b,$04</td>
<td class="comment-1" rowspan="1">Loop counter (4 platforms for draw)</td>
</tr>
<tr>
<td class="address-1"><span id="30266"></span>763a</td>
<td class="instruction">ld hl,$6003</td>
<td class="comment-1" rowspan="1">Platform location/size params</td>
</tr>
<tr>
<td class="address-2"><span id="30269"></span>763d</td>
<td class="instruction">push bc</td>
<td class="comment-1" rowspan="1">Backup loop counter</td>
</tr>
<tr>
<td class="address-1"><span id="30270"></span>763e</td>
<td class="instruction">ld a,(hl)</td>
<td class="comment-1" rowspan="3">Process next platform if sprite colour is black/unused</td>
</tr>
<tr>
<td class="address-1"><span id="30271"></span>763f</td>
<td class="instruction">and a</td>
</tr>
<tr>
<td class="address-1"><span id="30272"></span>7640</td>
<td class="instruction">jp z,$769e</td>
</tr>
<tr>
<td class="address-1"><span id="30275"></span>7643</td>
<td class="instruction">inc hl</td>
<td class="comment-1" rowspan="2"><span class="register">C</span>=X position</td>
</tr>
<tr>
<td class="address-1"><span id="30276"></span>7644</td>
<td class="instruction">ld c,(hl)</td>
</tr>
<tr>
<td class="address-1"><span id="30277"></span>7645</td>
<td class="instruction">inc hl</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="30278"></span>7646</td>
<td class="instruction">inc hl</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="30279"></span>7647</td>
<td class="instruction">ld a,(hl)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=platform width</td>
</tr>
<tr>
<td class="address-1"><span id="30280"></span>7648</td>
<td class="instruction">and $fc</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="30282"></span>764a</td>
<td class="instruction">neg</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="30284"></span>764c</td>
<td class="instruction">add a,c</td>
<td class="comment-1" rowspan="1"><span class="register">A</span> += platform X position</td>
</tr>
<tr>
<td class="address-1"><span id="30285"></span>764d</td>
<td class="instruction">add a,$10</td>
<td class="comment-1" rowspan="1"><span class="register">A</span> += 16</td>
</tr>
<tr>
<td class="address-1"><span id="30287"></span>764f</td>
<td class="instruction">push hl</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="30288"></span>7650</td>
<td class="instruction">dec hl</td>
<td class="comment-1" rowspan="2"><span class="register">H</span>=Y position byte</td>
</tr>
<tr>
<td class="address-1"><span id="30289"></span>7651</td>
<td class="instruction">ld h,(hl)</td>
</tr>
<tr>
<td class="address-1"><span id="30290"></span>7652</td>
<td class="instruction">ld l,a</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=new X position</td>
</tr>
<tr>
<td class="address-1"><span id="30291"></span>7653</td>
<td class="instruction">call <a href="29392.html">$72d0</a></td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=coord to screen address (using <span class="register">HL</span>)</td>
</tr>
<tr>
<td class="address-1"><span id="30294"></span>7656</td>
<td class="instruction">ld de,$76ad</td>
<td class="comment-1" rowspan="1"><span class="register">DE</span>=address for LEFT platform sprite</td>
</tr>
<tr>
<td class="address-1"><span id="30297"></span>7659</td>
<td class="instruction">call <a href="30374.html">$76a6</a></td>
<td class="comment-1" rowspan="1">Draw LEFT platform tile pixels</td>
</tr>
<tr>
<td class="address-1"><span id="30300"></span>765c</td>
<td class="instruction">ex (sp),hl</td>
<td class="comment-1" rowspan="6">Does this fetch the platform width value?</td>
</tr>
<tr>
<td class="address-1"><span id="30301"></span>765d</td>
<td class="instruction">ld a,(hl)</td>
</tr>
<tr>
<td class="address-1"><span id="30302"></span>765e</td>
<td class="instruction">ex (sp),hl</td>
</tr>
<tr>
<td class="address-1"><span id="30303"></span>765f</td>
<td class="instruction">srl a</td>
</tr>
<tr>
<td class="address-1"><span id="30305"></span>7661</td>
<td class="instruction">srl a</td>
</tr>
<tr>
<td class="address-1"><span id="30307"></span>7663</td>
<td class="instruction">sub $04</td>
</tr>
<tr>
<td class="address-1"><span id="30309"></span>7665</td>
<td class="instruction">ld b,a</td>
<td class="comment-1" rowspan="1"><span class="register">B</span>=loop counter for # of middle platform sprites</td>
</tr>
<tr>
<td class="address-1"><span id="30310"></span>7666</td>
<td class="instruction">ld de,$76b5</td>
<td class="comment-1" rowspan="1"><span class="register">DE</span>=address for MIDDLE platform sprite</td>
</tr>
<tr>
<td class="address-2"><span id="30313"></span>7669</td>
<td class="instruction">call <a href="30374.html">$76a6</a></td>
<td class="comment-1" rowspan="2">Draw (all) MIDDLE platform tiles pixels</td>
</tr>
<tr>
<td class="address-1"><span id="30316"></span>766c</td>
<td class="instruction">djnz $7669</td>
</tr>
<tr>
<td class="address-1"><span id="30318"></span>766e</td>
<td class="instruction">ld de,$76bd</td>
<td class="comment-1" rowspan="1"><span class="register">DE</span>=address for RIGHT platform sprite</td>
</tr>
<tr>
<td class="address-1"><span id="30321"></span>7671</td>
<td class="instruction">call <a href="30374.html">$76a6</a></td>
<td class="comment-1" rowspan="1">Draw RIGHT platform tile pixels</td>
</tr>
<tr>
<td class="address-1"><span id="30324"></span>7674</td>
<td class="instruction">pop hl</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="30325"></span>7675</td>
<td class="instruction">ld a,(hl)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=platform width</td>
</tr>
<tr>
<td class="address-1"><span id="30326"></span>7676</td>
<td class="instruction">and $fc</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="30328"></span>7678</td>
<td class="instruction">neg</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="30330"></span>767a</td>
<td class="instruction">add a,c</td>
<td class="comment-1" rowspan="1"><span class="register">A</span> += X position</td>
</tr>
<tr>
<td class="address-1"><span id="30331"></span>767b</td>
<td class="instruction">add a,$10</td>
<td class="comment-1" rowspan="1"><span class="register">A</span> += 16</td>
</tr>
<tr>
<td class="address-1"><span id="30333"></span>767d</td>
<td class="instruction">push hl</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="30334"></span>767e</td>
<td class="instruction">dec hl</td>
<td class="comment-1" rowspan="2"><span class="register">B</span>=Y position</td>
</tr>
<tr>
<td class="address-1"><span id="30335"></span>767f</td>
<td class="instruction">ld b,(hl)</td>
</tr>
<tr>
<td class="address-1"><span id="30336"></span>7680</td>
<td class="instruction">dec hl</td>
<td class="comment-1" rowspan="3"><span class="register">C</span>=colour attribute</td>
</tr>
<tr>
<td class="address-1"><span id="30337"></span>7681</td>
<td class="instruction">dec hl</td>
</tr>
<tr>
<td class="address-1"><span id="30338"></span>7682</td>
<td class="instruction">ld c,(hl)</td>
</tr>
<tr>
<td class="address-1"><span id="30339"></span>7683</td>
<td class="instruction">ld h,b</td>
<td class="comment-1" rowspan="2"><span class="register">HL</span>=Y,X position</td>
</tr>
<tr>
<td class="address-1"><span id="30340"></span>7684</td>
<td class="instruction">ld l,a</td>
</tr>
<tr>
<td class="address-1"><span id="30341"></span>7685</td>
<td class="instruction">push bc</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="30342"></span>7686</td>
<td class="instruction">call <a href="29142.html">$71d6</a></td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=coord to attribute file address (using <span class="register">HL</span>)</td>
</tr>
<tr>
<td class="address-1"><span id="30345"></span>7689</td>
<td class="instruction">pop bc</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="30346"></span>768a</td>
<td class="instruction">ex (sp),hl</td>
<td class="comment-1" rowspan="6">Does this fetch the platform width value?</td>
</tr>
<tr>
<td class="address-1"><span id="30347"></span>768b</td>
<td class="instruction">ld a,(hl)</td>
</tr>
<tr>
<td class="address-1"><span id="30348"></span>768c</td>
<td class="instruction">ex (sp),hl</td>
</tr>
<tr>
<td class="address-1"><span id="30349"></span>768d</td>
<td class="instruction">srl a</td>
</tr>
<tr>
<td class="address-1"><span id="30351"></span>768f</td>
<td class="instruction">srl a</td>
</tr>
<tr>
<td class="address-1"><span id="30353"></span>7691</td>
<td class="instruction">sub $02</td>
</tr>
<tr>
<td class="address-1"><span id="30355"></span>7693</td>
<td class="instruction">ld b,a</td>
<td class="comment-1" rowspan="1"><span class="register">B</span>=loop counter for # of middle platform sprites</td>
</tr>
<tr>
<td class="address-1"><span id="30356"></span>7694</td>
<td class="instruction">ld a,c</td>
<td class="comment-1" rowspan="2">Apply platform colour to ATTRIBUTE_FILE</td>
</tr>
<tr>
<td class="address-2"><span id="30357"></span>7695</td>
<td class="instruction">ld (hl),a</td>
</tr>
<tr>
<td class="address-1"><span id="30358"></span>7696</td>
<td class="instruction">inc hl</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=next sprite position</td>
</tr>
<tr>
<td class="address-1"><span id="30359"></span>7697</td>
<td class="instruction">djnz $7695</td>
<td class="comment-1" rowspan="1">Repeat until all sprites are coloured</td>
</tr>
<tr>
<td class="address-1"><span id="30361"></span>7699</td>
<td class="instruction">pop hl</td>
<td class="comment-1" rowspan="1">Restore <span class="register">HL</span>=platform object at "width" byte</td>
</tr>
<tr>
<td class="address-1"><span id="30362"></span>769a</td>
<td class="instruction">inc hl</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=beginning of next platform struct</td>
</tr>
<tr>
<td class="address-1"><span id="30363"></span>769b</td>
<td class="instruction">pop bc</td>
<td class="comment-1" rowspan="1">Restore <span class="register">BC</span> for loop counter</td>
</tr>
<tr>
<td class="address-1"><span id="30364"></span>769c</td>
<td class="instruction">jr $76a3</td>
<td class="comment-1" rowspan="1">Loop back and processing next platform</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="30366"></span>
<div class="comments">
<div class="paragraph">
These instructions are only called if current platform colour was black. Why would a platform colour be black?
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="30366"></span>769e</td>
<td class="instruction">pop bc</td>
<td class="comment-1" rowspan="1">restore loop counter</td>
</tr>
<tr>
<td class="address-1"><span id="30367"></span>769f</td>
<td class="instruction">inc hl</td>
<td class="comment-1" rowspan="4">Place <span class="register">HL</span> to beginning of next platform struct</td>
</tr>
<tr>
<td class="address-1"><span id="30368"></span>76a0</td>
<td class="instruction">inc hl</td>
</tr>
<tr>
<td class="address-1"><span id="30369"></span>76a1</td>
<td class="instruction">inc hl</td>
</tr>
<tr>
<td class="address-1"><span id="30370"></span>76a2</td>
<td class="instruction">inc hl</td>
</tr>
<tr>
<td class="address-2"><span id="30371"></span>76a3</td>
<td class="instruction">djnz $763d</td>
<td class="comment-1" rowspan="1">Loop back and process next platform</td>
</tr>
<tr>
<td class="address-1"><span id="30373"></span>76a5</td>
<td class="instruction">ret</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="30204.html">75fc</a>
</td>
<td class="up">Up: <a href="../maps/all.html#30264">Map</a></td>
<td class="next">
Next: <a href="30374.html">76a6</a>
</td>
</tr>
</table>
<footer>
<div class="release"></div>
<div class="copyright"></div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.6b1.</div>
</footer>
</body>
</html>